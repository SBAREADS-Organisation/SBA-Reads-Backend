name: Deploy to AWS EC2

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          
      - name: Cache NPM dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          
      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader --no-progress --no-interaction
        
      - name: Install Node dependencies and build
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
          npm run build
          
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Install system dependencies if not present
            if ! command -v php &> /dev/null; then
              sudo apt update
              # Add PHP PPA repository
              sudo apt install -y software-properties-common
              sudo add-apt-repository -y ppa:ondrej/php
              sudo apt update
              # Install PHP 8.2 and extensions (pcntl is not available, remove it)
              sudo apt install -y php8.2 php8.2-fpm php8.2-pgsql php8.2-mbstring php8.2-xml php8.2-curl php8.2-zip php8.2-bcmath php8.2-gd php8.2-redis php8.2-exif php8.2-cli composer unzip
              # Install nginx separately
              sudo apt install -y nginx
            fi
            
            # Install Redis if not present
            if ! command -v redis-server &> /dev/null; then
              sudo apt install -y redis-server
              sudo systemctl start redis-server
              sudo systemctl enable redis-server
            fi
            
            # Install PostgreSQL client if not present
            if ! command -v psql &> /dev/null; then
              sudo apt install -y postgresql-client
            fi
            
            # Setup application directory
            if [ ! -d "/home/ubuntu/SBA-Reads-Backend" ]; then
              cd /home/ubuntu
              git clone https://${{ secrets.PAT }}@github.com/SBAREADS-Organisation/SBA-Reads-Backend.git
            else
              # Ensure it's a git repository
              cd /home/ubuntu/SBA-Reads-Backend
              if ! git rev-parse --git-dir > /dev/null 2>&1; then
                cd /home/ubuntu
                rm -rf SBA-Reads-Backend
                git clone https://${{ secrets.PAT }}@github.com/SBAREADS-Organisation/SBA-Reads-Backend.git
              fi
            fi
            
            # Use existing directory
            cd /home/ubuntu/SBA-Reads-Backend
            
            # Pull latest changes
            git pull origin main
            
            # Install PHP dependencies
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Create .env file
            sudo cp .env.example .env
            sudo chown ubuntu:ubuntu .env
            cat > .env << EOF
            APP_NAME="SBA Reads"
            APP_ENV=production
            APP_DEBUG=false
            APP_URL=${{ secrets.APP_URL }}
            DB_CONNECTION=pgsql
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=5432
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            CACHE_STORE=redis
            REDIS_HOST=127.0.0.1
            REDIS_PORT=6379
            QUEUE_CONNECTION=redis
            SESSION_DRIVER=database
            LOG_CHANNEL=stack
            LOG_LEVEL=error
            EOF
            
            # Generate app key
            php artisan key:generate --force
            
            # Run migrations and seed
            php artisan migrate --force
            php artisan db:seed --force
            
            # Set up Nginx
            sudo tee /etc/nginx/sites-available/sba-reads > /dev/null << 'EOF'
            server {
                listen 80;
                server_name ${{ secrets.EC2_HOST }};
                root /home/ubuntu/SBA-Reads-Backend/public;
                index index.php index.html;

                location / {
                    try_files $uri $uri/ /index.php?$query_string;
                }

                location ~ \.php$ {
                    fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
                    fastcgi_index index.php;
                    include fastcgi_params;
                    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                }

                location ~ /\.ht {
                    deny all;
                }
            }
            EOF
            
            # Enable the site
            sudo ln -sf /etc/nginx/sites-available/sba-reads /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t
            sudo systemctl restart nginx
            
            # Set permissions
            sudo chown -R www-data:www-data /home/ubuntu/SBA-Reads-Backend/storage /home/ubuntu/SBA-Reads-Backend/bootstrap/cache
            sudo chmod -R 775 /home/ubuntu/SBA-Reads-Backend/storage /home/ubuntu/SBA-Reads-Backend/bootstrap/cache
            sudo chown -R ubuntu:ubuntu /home/ubuntu/SBA-Reads-Backend
            
            # Start PHP-FPM
            sudo systemctl start php8.2-fpm
            sudo systemctl enable php8.2-fpm
            
            # Optimize Laravel
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan cache:clear
            
            # Create storage link
            php artisan storage:link
            
            # Restart queue workers
            php artisan queue:restart
            
            # Test the application
            curl -f http://localhost/api/subscriptions || exit 1
